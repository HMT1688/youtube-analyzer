<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stats.title }} - 분석 결과</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .page-link.active { z-index: 10; color: #fff; background-color: #ef4444; border-color: #ef4444; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ef4444; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #srt-text::-webkit-scrollbar { width: 8px; }
        #srt-text::-webkit-scrollbar-track { background: #f1f1f1; }
        #srt-text::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        #srt-text::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 space-y-8 font-sans">
    <div class="max-w-7xl mx-auto">
        <!-- 채널 헤더 -->
        <header class="bg-white p-6 rounded-lg shadow-md flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
            <img src="{{ stats.profile_image }}" alt="프로필" class="w-24 h-24 rounded-full border-2 border-gray-200">
            <div class="flex-grow text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">{{ stats.title }}</h1>
                <p class="text-gray-500 mt-1">구독자 {{ "{:,}".format(stats.subscribers) }}명 • 영상 {{ "{:,}".format(stats.video_count) }}개</p>
            </div>
             <a href="/" class="text-sm text-blue-600 hover:underline mt-2 md:mt-0">&larr; 다른 채널 분석</a>
        </header>

        <!-- 심층 분석 -->
        <section>
            <h2 class="text-2xl font-bold text-gray-700 my-4">채널 심층 분석</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <h3 class="font-semibold text-gray-600 mb-1">주간 평균 업로드</h3>
                    <p class="text-2xl font-bold text-blue-600">{{ analysis.uploads_per_week }} 개</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <h3 class="font-semibold text-gray-600 mb-1">평균 영상 길이</h3>
                    <p class="text-2xl font-bold text-blue-600">{{ analysis.avg_duration }}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <h3 class="font-semibold text-gray-600 mb-1">1천뷰 당 좋아요</h3>
                    <p class="text-2xl font-bold text-green-600">{{ analysis.likes_per_1000_views }} 개</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <h3 class="font-semibold text-gray-600 mb-1">1천뷰 당 댓글</h3>
                    <p class="text-2xl font-bold text-green-600">{{ analysis.comments_per_1000_views }} 개</p>
                </div>
            </div>
        </section>
        
        <!-- 동영상 목록 -->
        <section>
             <h2 class="text-2xl font-bold text-gray-700 my-4">동영상 목록</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% for v in videos %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col">
                    <a href="{{ v.url }}" target="_blank"><img src="{{ v.thumb }}" alt="{{ v.title }}" class="w-full h-40 object-cover"></a>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-bold text-sm mb-2 flex-grow h-10 line-clamp-2">{{ v.title }}</h3>
                        <div class="text-xs text-gray-500 space-y-1 mb-3">
                            <p>조회수: <span class="font-medium">{{ "{:,}".format(v.views) }}</span></p>
                            <p>업로드: <span class="font-medium">{{ v.published.date() }}</span></p>
                        </div>
                        <div class="mt-auto pt-2 border-t border-gray-200 text-center text-xs space-x-2 font-semibold">
                             <button onclick="showCaption('{{ v.id }}', false)" class="text-blue-600 hover:underline">자막</button>
                             <span>|</span>
                             <button onclick="showCaption('{{ v.id }}', true)" class="text-purple-600 hover:underline">AI자막</button>
                             <span>|</span>
                             <a href="/download-video/{{ v.id }}" class="text-green-600 hover:underline">다운</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- 페이지네이션 버튼 -->
        <nav class="mt-8 flex justify-center">
            <ul class="inline-flex items-center -space-x-px">
                 {% if current_page > 1 %}
                <li><a href="/analyze?url={{ original_url }}&page={{ current_page - 1 }}" class="py-2 px-3 ml-0 leading-tight text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100">이전</a></li>
                {% endif %}
                {% set page_range = 5 %}
                {% set start_page = [1, current_page - page_range // 2] | max %}
                {% set end_page = [total_pages, start_page + page_range - 1] | min %}
                {% if end_page - start_page + 1 < page_range %}
                    {% set start_page = [1, end_page - page_range + 1] | max %}
                {% endif %}
                
                {% for p in range(start_page, end_page + 1) %}
                <li><a href="/analyze?url={{ original_url }}&page={{ p }}" class="page-link py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 {% if p == current_page %}active{% endif %}">{{ p }}</a></li>
                {% endfor %}

                {% if current_page < total_pages %}
                <li><a href="/analyze?url={{ original_url }}&page={{ current_page + 1 }}" class="py-2 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100">다음</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <!-- ✨ 자막 팝업(모달) ✨ -->
    <div id="caption-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="caption-title" class="text-lg font-bold text-gray-800 truncate">자막 내용</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="caption-content" class="p-4 sm:p-6 overflow-y-auto">
                <div id="loader" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                <pre id="srt-text" class="font-mono text-sm whitespace-pre-wrap break-words hidden"></pre>
            </div>
             <div class="p-3 border-t text-right bg-gray-50 rounded-b-lg">
                <button id="copy-button" onclick="copyCaption()" class="bg-gray-200 text-gray-700 text-xs font-bold py-1 px-3 rounded hover:bg-gray-300 transition">본문 복사</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('caption-modal');
        const captionTitle = document.getElementById('caption-title');
        const srtText = document.getElementById('srt-text');
        const loader = document.getElementById('loader');
        const copyButton = document.getElementById('copy-button');

        async function showCaption(videoId, isAi) {
            modal.classList.remove('hidden');
            loader.style.display = 'flex';
            srtText.classList.add('hidden');
            srtText.textContent = '';
            captionTitle.textContent = '자막을 불러오는 중...';
            copyButton.textContent = '본문 복사';
            const url = isAi ? `/get-caption-ai/${videoId}` : `/get-caption/${videoId}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                loader.style.display = 'none';
                if (data.error) { srtText.textContent = `오류: ${data.error}`; } 
                else {
                    captionTitle.textContent = data.title;
                    srtText.textContent = data.srt_content;
                }
                srtText.classList.remove('hidden');
            } catch (error) {
                loader.style.display = 'none';
                srtText.textContent = '자막을 가져오는데 실패했습니다. 네트워크 연결을 확인해주세요.';
                srtText.classList.remove('hidden');
            }
        }
        function closeModal() { modal.classList.add('hidden'); }
        function copyCaption() {
            if (navigator.clipboard) {
                 navigator.clipboard.writeText(srtText.textContent).then(() => {
                    copyButton.textContent = '복사 완료!';
                    setTimeout(() => { copyButton.textContent = '본문 복사'; }, 2000);
                }).catch(err => { alert('자막 복사에 실패했습니다.'); });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = srtText.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyButton.textContent = '복사 완료!';
                    setTimeout(() => { copyButton.textContent = '본문 복사'; }, 2000);
                } catch (err) { alert('자막 복사에 실패했습니다.'); }
                document.body.removeChild(textarea);
            }
        }
        window.onclick = (event) => { if (event.target == modal) closeModal(); }
        document.addEventListener('keydown', (event) => { if (event.key === "Escape") closeModal(); });
    </script>
</body>
</html>
