<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ stats.title }} - 분석 결과</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .page-link.active {
      z-index:10;
      color:#fff;
      background-color:#ef4444;
      border-color:#ef4444;
    }
    .loader {
      border:4px solid #f3f3f3;
      border-top:4px solid #ef4444;
      border-radius:50%;
      width:40px; height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8 font-sans">
  <div class="max-w-7xl mx-auto space-y-8">
    <!-- 헤더 -->
    <header class="bg-white p-6 rounded-lg shadow flex flex-col md:flex-row items-center space-y-4 md:space-x-6">
      <img src="{{ stats.profile_image }}" alt="" class="w-24 h-24 rounded-full border-2"/>
      <div class="flex-1 text-center md:text-left">
        <h1 class="text-2xl font-bold">{{ stats.title }}</h1>
        <p class="text-gray-500 mt-1">
          구독자 {{ "{:,}".format(stats.subscribers) }}명 • 영상 {{ "{:,}".format(stats.video_count) }}개
        </p>
      </div>
      <a href="/" class="text-blue-600 hover:underline">← 다른 채널 분석</a>
    </header>

    <!-- 통계 카드 -->
    <section class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded shadow text-center">
        <h3 class="font-semibold text-gray-600">주간 평균 업로드</h3>
        <p class="text-blue-600 text-xl">{{ analysis.uploads_per_week }}개</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h3 class="font-semibold text-gray-600">평균 영상 길이</h3>
        <p class="text-blue-600 text-xl">{{ analysis.avg_duration }}</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h3 class="font-semibold text-gray-600">1천뷰 당 좋아요</h3>
        <p class="text-green-600 text-xl">{{ analysis.likes_per_1000_views }}개</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h3 class="font-semibold text-gray-600">1천뷰 당 댓글</h3>
        <p class="text-green-600 text-xl">{{ analysis.comments_per_1000_views }}개</p>
      </div>
    </section>

    <!-- 동영상 목록 -->
    <section>
      <h2 class="text-2xl font-bold mb-4">동영상 목록</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for v in videos %}
        <div class="bg-white rounded shadow overflow-hidden flex flex-col">
          <img src="{{ v.thumb }}" alt="" class="w-full h-40 object-cover"/>
          <div class="p-4 flex flex-col flex-grow">
            <h3 class="font-semibold truncate mb-2">{{ v.title }}</h3>
            <p class="text-sm text-gray-500">조회 {{ "{:,}".format(v.views) }}회</p>
            <p class="text-sm text-gray-500">업로드 {{ v.published.date() }}</p>
            <div class="mt-auto pt-2 border-t flex justify-center space-x-2 text-xs font-semibold">
              <button onclick="showCaption('{{ v.id }}',false)" class="text-blue-600 hover:underline">자막</button>
              <button onclick="showCaption('{{ v.id }}',true)" class="text-purple-600 hover:underline">AI자막</button>
              <a href="/download-video/{{ v.id }}" class="text-green-600 hover:underline">다운</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      <!-- 페이지네이션 -->
      <nav class="mt-8 flex justify-center">
        <ul class="inline-flex -space-x-px">
          {% if current_page>1 %}
          <li><a href="/analyze?url={{ original_url }}&page={{ current_page-1 }}" class="px-3 py-1 border bg-white">이전</a></li>
          {% endif %}
          {% for p in range(1, total_pages+1) %}
          <li><a href="/analyze?url={{ original_url }}&page={{ p }}"
                class="px-3 py-1 border {% if p==current_page %}bg-red-500 text-white{% else %}bg-white{% endif %}">{{ p }}</a></li>
          {% endfor %}
          {% if current_page<total_pages %}
          <li><a href="/analyze?url={{ original_url }}&page={{ current_page+1 }}" class="px-3 py-1 border bg-white">다음</a></li>
          {% endif %}
        </ul>
      </nav>
    </section>
  </div>

  <!-- 자막 모달 -->
  <div id="caption-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 id="caption-title" class="font-bold">자막 로딩 중...</h2>
        <button onclick="closeModal()" class="text-2xl">&times;</button>
      </div>
      <div id="caption-body" class="p-4 overflow-y-auto flex-1">
        <div id="loader" class="loader mx-auto my-20"></div>
        <pre id="srt-text" class="hidden font-mono whitespace-pre-wrap break-words"></pre>
      </div>
      <div class="p-3 border-t text-right bg-gray-50">
        <button id="copy-btn" onclick="copyCaption()" class="bg-gray-200 px-3 py-1 rounded">복사</button>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('caption-modal');
    const loader = document.getElementById('loader');
    const srtText = document.getElementById('srt-text');
    const titleEl = document.getElementById('caption-title');
    const copyBtn = document.getElementById('copy-btn');

    async function showCaption(id, ai) {
      modal.classList.remove('hidden');
      loader.style.display = 'block';
      srtText.classList.add('hidden');
      titleEl.textContent = '자막 로딩 중...';

      try {
        const res = await fetch(ai?`/get-caption-ai/${id}`:`/get-caption/${id}`);
        const data = await res.json();
        loader.style.display = 'none';
        if (data.error) {
          srtText.textContent = `오류: ${data.error}`;
        } else {
          titleEl.textContent = data.title;
          srtText.textContent = data.srt_content;
        }
        srtText.classList.remove('hidden');
      } catch {
        loader.style.display = 'none';
        srtText.textContent = '네트워크 오류';
        srtText.classList.remove('hidden');
      }
    }
    function closeModal() { modal.classList.add('hidden'); }
    function copyCaption() {
      navigator.clipboard.writeText(srtText.textContent);
      copyBtn.textContent='복사 완료';
      setTimeout(()=>copyBtn.textContent='복사',2000);
    }
    window.onclick = e => { if (e.target===modal) closeModal(); }
    document.addEventListener('keydown', e => { if (e.key==='Escape') closeModal(); });
  </script>
</body>
</html>
